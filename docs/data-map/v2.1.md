# GAIA v2.1 Data Map

## Database Schema & Encryption Strategy

### Overview

This document outlines all D1 tables, their columns, and which fields are encrypted at rest.

**Legend**:
- `ENC`: Field is encrypted on client before sending to API; D1 stores base64 ciphertext
- `PLAIN`: Plaintext storage; not sensitive or intended to be private
- `FK`: Foreign key reference
- `PRIMARY`: Primary key

---

## Tables

### 1. `users`

User account records.

| Column | Type | Constraints | Encryption | Notes |
|--------|------|-------------|-----------|-------|
| `id` | TEXT | PRIMARY | - | User ID (UUID) |
| `email` | TEXT | UNIQUE, NOT NULL | - | Plaintext email for auth/lookup |
| `created_at` | INTEGER | NOT NULL | - | Timestamp (ms) |

**Encryption**: None (auth data)

---

### 2. `settings`

Per-user configuration and preferences (cloud-backed).

| Column | Type | Constraints | Encryption | Notes |
|--------|------|-------------|-----------|-------|
| `user_id` | TEXT | FK(users) | - | User reference |
| `key` | TEXT | NOT NULL | - | Setting key (e.g., "theme", "language") |
| `value` | TEXT | - | PLAIN | JSON string; plaintext |
| `updated_at` | INTEGER | NOT NULL | - | Last update timestamp |

**Encryption**: None (non-sensitive config)

**Example**:
```json
{ "user_id": "uuid-123", "key": "theme", "value": "dark" }
```

---

### 3. `learning_progress`

User progress in learning topics (prep for future academy moves).

| Column | Type | Constraints | Encryption | Notes |
|--------|------|-------------|-----------|-------|
| `user_id` | TEXT | FK(users) | - | User reference |
| `topic` | TEXT | NOT NULL | - | Topic identifier |
| `xp` | INTEGER | - | - | Experience points |
| `percent` | INTEGER | - | - | Completion percentage |
| `last_touched` | INTEGER | - | - | Last interaction timestamp |

**Encryption**: None (learning stats)

---

### 4. `academy_results`

Quiz and assessment results.

| Column | Type | Constraints | Encryption | Notes |
|--------|------|-------------|-----------|-------|
| `id` | TEXT | PRIMARY | - | Result ID (UUID) |
| `user_id` | TEXT | FK(users) | - | User reference |
| `quiz_id` | TEXT | NOT NULL | - | Quiz identifier |
| `topic` | TEXT | NOT NULL | - | Topic/subject |
| `correct_count` | INTEGER | NOT NULL | - | Number of correct answers |
| `total` | INTEGER | NOT NULL | - | Total questions |
| `percent` | INTEGER | NOT NULL | - | Percentage score |
| `wrong_tags` | TEXT | - | PLAIN | JSON array of wrong topic tags |
| `created_at` | INTEGER | NOT NULL | - | Timestamp |

**Encryption**: None (academic records)

---

### 5. `labs`

Lab experiment/project records.

| Column | Type | Constraints | Encryption | Notes |
|--------|------|-------------|-----------|-------|
| `id` | TEXT | PRIMARY | - | Lab ID (UUID) |
| `user_id` | TEXT | FK(users) | - | User reference |
| `topic` | TEXT | NOT NULL | - | Lab topic |
| `tags` | TEXT | - | PLAIN | JSON array of tags |
| `prompt` | TEXT | - | PLAIN | Lab description/prompt |
| `created_at` | INTEGER | NOT NULL | - | Timestamp |

**Encryption**: None (educational content)

---

### 6. `health_conditions` ⚠️ SENSITIVE

User health conditions (chronic diseases, diagnoses).

| Column | Type | Constraints | Encryption | Notes |
|--------|------|-------------|-----------|-------|
| `id` | TEXT | PRIMARY | - | Condition ID (UUID) |
| `user_id` | TEXT | FK(users) | - | User reference |
| `name` | TEXT | NOT NULL | **ENC** | Condition name (e.g., "Type 2 Diabetes") |
| `notes` | TEXT | - | **ENC** | Additional notes/history |
| `created_at` | INTEGER | NOT NULL | - | Timestamp |

**Encryption**: `name`, `notes`

**Example D1 Storage**:
```json
{
  "id": "cond-123",
  "user_id": "user-456",
  "name": "KgJmK3Z9pL2mN1qOr4sT5uVwXyZaBcDeFg==",
  "notes": "aBcDeFgHiJkLmNoPqRsTuVwXyZ1a2b3c4d==",
  "created_at": 1699000000000
}
```

---

### 7. `health_meds` ⚠️ SENSITIVE

User medications and prescriptions.

| Column | Type | Constraints | Encryption | Notes |
|--------|------|-------------|-----------|-------|
| `id` | TEXT | PRIMARY | - | Medication ID (UUID) |
| `user_id` | TEXT | FK(users) | - | User reference |
| `name` | TEXT | NOT NULL | **ENC** | Medication name |
| `dose` | TEXT | - | **ENC** | Dose amount (e.g., "500 mg") |
| `unit` | TEXT | - | **ENC** | Unit (mg, ml, tablets, etc.) |
| `schedule` | TEXT | - | **ENC** | JSON: frequency, times per day |
| `created_at` | INTEGER | NOT NULL | - | Timestamp |

**Encryption**: `name`, `dose`, `unit`, `schedule`

**Example Schedule (Encrypted)**:
```json
{
  "frequency": "daily",
  "times": [8, 14, 20],
  "days": ["mon", "tue", "wed", "thu", "fri", "sat", "sun"]
}
```

---

### 8. `health_metrics` ⚠️ SENSITIVE (Partial)

User health measurements (vitals, lab values).

| Column | Type | Constraints | Encryption | Notes |
|--------|------|-------------|-----------|-------|
| `id` | TEXT | PRIMARY | - | Metric ID (UUID) |
| `user_id` | TEXT | FK(users) | - | User reference |
| `date` | INTEGER | NOT NULL | - | Measurement date (epoch ms) |
| `weight` | REAL | - | PLAIN | Weight in kg (not highly sensitive) |
| `bg_fasting` | REAL | - | PLAIN | Fasting blood glucose |
| `bg_post` | REAL | - | PLAIN | Post-meal blood glucose |
| `notes` | TEXT | - | **ENC** | Optional notes |
| `created_at` | INTEGER | NOT NULL | - | Timestamp |

**Encryption**: `notes` (numeric measurements left plaintext for trending queries)

---

## Encryption Details

### Algorithm: AES-GCM (256-bit)

**Parameters**:
- **Key Size**: 256 bits (32 bytes)
- **IV Size**: 12 bytes (96 bits) - randomly generated per encryption
- **Authentication**: GCM mode ensures integrity

**Process**:

1. **Encryption**:
   ```
   plaintext → UTF-8 bytes → AES-GCM encrypt → IV + ciphertext → Base64
   ```

2. **Storage**:
   ```
   Base64 string stored in D1 (unreadable without decryption key)
   ```

3. **Decryption**:
   ```
   Base64 → IV + ciphertext → AES-GCM decrypt → plaintext UTF-8
   ```

### Key Derivation (Week 4)

**Current (Dev)**:
```typescript
// From environment
const devKeyB64 = process.env.NEXT_PUBLIC_ELEUTHIA_DEV_KEY;
// Import as CryptoKey for AES-GCM
```

**Future (Week 6)**:
```typescript
// Derived from user auth
const userSecret = /* from supabase auth */;
const masterKey = /* from app config */;
const derived = await PBKDF2(userSecret + masterKey, salt, iterations);
```

---

## Indexes

For performance on common queries:

```sql
CREATE INDEX idx_settings_user_id ON settings(user_id);
CREATE INDEX idx_learning_progress_user_id ON learning_progress(user_id);
CREATE INDEX idx_academy_results_user_id ON academy_results(user_id);
CREATE INDEX idx_labs_user_id ON labs(user_id);
CREATE INDEX idx_health_conditions_user_id ON health_conditions(user_id);
CREATE INDEX idx_health_meds_user_id ON health_meds(user_id);
CREATE INDEX idx_health_metrics_user_id ON health_metrics(user_id);
CREATE INDEX idx_health_metrics_user_date ON health_metrics(user_id, date);
```

---

## Security Model

### Threat Model

| Threat | Mitigation |
|--------|-----------|
| D1 data breach | Encrypted fields are unreadable |
| API intercept (HTTPS) | Use HTTPS only; TLS encrypts in transit |
| Key compromise | Week 6: rotate keys, invalidate old records |
| Plaintext logging | Never log plaintext sensitive fields |

### Data Lifecycle

1. **Create**: User enters plaintext → client encrypts → API receives ciphertext → D1 stores
2. **Read**: D1 returns ciphertext → client decrypts → rendered plaintext
3. **Update**: Decrypt → edit → re-encrypt → send → D1 updates
4. **Delete**: User confirms → API deletes row (no decrypt needed)

---

## Compliance & Privacy

- **HIPAA** (US): Encrypted health data aligns with safeguards rule
- **GDPR** (EU): Encryption supports data protection by design
- **User Control**: Users can export/delete all their encrypted data
- **Server Transparency**: Server never sees plaintext health data

---

## Testing & Verification

See `docs/how-to/verify-ciphertext.md` for steps to verify ciphertext in D1.
